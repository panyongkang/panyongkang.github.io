title: 银行卡业务
tags: [银行卡]
categories: [工作笔记]
message: 您好，本篇文章需密码访问，请谅解！
password: card0113
date: 2020-07-10 20:55:00

---

## 卡的基本流程

卡的基本流程：1036-1038-1030-1046-1031-1032-1034-1035-1010-1025-1026-1027

1036：空白卡入库

1038：空白卡领用/上缴

1030：预制卡申请

1046：制卡文件生成（新核心需要先做cd01批处理）

cd01：预制卡申请批量处理

1031：预制卡/预约卡入库

1032：预制卡库间调拨（新核心需要先进行1067申请，1068审核）

1067：预制卡调拨申请

1068：预制卡调拨申请处理

1034：柜员领用上缴卡凭证

1035：柜员调剂卡凭证

1010：实时单张发个人卡主卡

1025：实时/预约单张换卡

1026：个人卡销卡

1027：单位结算卡销卡

### 空白卡入库（cd1036)

**功能详细描述**

用于空白卡入库，该交易由总行库管柜员操作。

**业务操作流程**

1. 凭证合法性检查
2. 柜员合法性检查
3. 增加空白卡库存
4. 记表外单边记账
5. 登记卡凭证出入库登记簿（kcdb_kpzcrk)
6. 打印凭证信息

**业务操作流程图**

![图片](空白卡入库.png)

**业务规则**

1. 空白卡入库必须为卡凭证管理机构操作，目前为总行（未来可能下放分行）
2. 只允许库管员操作
3. 检查空白卡凭证是否启用
   * 卡凭证种类对照表（kcdp_kpzhdz)	0:已启用	1：已停用	2：已暂停
4. 空白卡仅作张数管理，无凭证号码的控制和管理
5. 增加空白卡库存
6. 登记出入库登记簿
7. 打印交易凭证
8. 空白卡凭证出库时检查凭证张数是否满足
9. 运用的表：kcdb_kpzkcn(卡凭证库存登记簿)、kcdp_kpzhdz(卡凭证种类对照表)、kcdb_kpzcrk(卡凭证出入库登记簿)
10. **注：有制卡柜员的存在制卡机构、产品代码通过参数控制是否启用**

### 空白卡领用/上缴（cd1038)

**功能详细描述**

制卡柜员从库管员尾箱中领用、上缴空白卡。

**业务操作流程**

1. 柜员凭证合法性检查
2. 领用时:库管员库存减少，制卡员尾箱增加
3. 上缴时：库管员库存增加，制卡员尾箱减少
4. 登记卡凭证出入库登记簿
5. 打印交易凭证

**业务操作流程图**

![图片](空白卡领用上缴.png)

**业务规则**

1. 具有制卡权限机构的库管员操作
2. 对方柜员应为具有凭证尾箱和制卡权限的制卡员
3. 制卡完成时，空白卡的领用和上缴只在制卡机构库管员和制卡柜员之间的操作，与交易机构是分开的。
4. 登记卡凭证出入库登记簿（kcdb_kpzkcn)
5. 打印交易凭证
6. 出库做凭证号段的拆分、入库做凭证号段的合并
7. 号段合并领用上缴的凭证的头或者尾跟库存的尾或者头能够相连，可直接拼接合并号段
8. 空白卡领用的会计分录

   * **借：增加对方柜员（制卡员）库存张数**
   * **贷：减少当前柜员（库管员）库存张数**
9. 空白卡上缴的会计分录

   * **借：增加当前柜员的库存张数**
   * **贷：减少对方柜员的库存张数**

### 预制卡申请(cd1030)

**功能详细描述**

用于预制卡申请，支持实时处理和批处理两种方式，目前采用联机批量处理。

**业务操作流程**

1. 输入合法性检查
2. 检查制卡数量是否超限
3. 检查该机构是否存在制卡中心（bFlag=YES)
4. 获取交易柜员表外尾箱
5. 生成批量标志
   * 实时：生成卡号并进行登记、记账、登记卡凭证库存登记簿
   * 批量：登记卡下批量代理业务登记簿
6. 登记预制卡登记簿(kcdb_yzdjxx)
7. 预制卡打印

**业务操作流程图**

![图片](预制卡申请.png)

**业务规则**

1. 应支持制卡申请操作的范围：如指定机构申请、指定中心申请、指定分行申请、指定区域内申请。
2. 表外库管员操作
3. 申请制卡的卡凭证库存状态：正常状态
4. 申请的凭证库存状态：在途状态；就是根据申请的张数，将卡产品对应的卡凭证类别下的空白卡转为“制卡在途”状态，供卡商制卡。
5. 申请机构当日申请每一种卡产品的总量不能超过50000张（可在卡杂项参数表中修改，这是目前贵阳银行的卡总量）
6. 生成申请编号，登记预制卡申请登记簿
7. **目前不走实时处理的代码，直接走联机批量的处理方式（代码中已修改）**
8. 打印交易凭证
9. 批量申请卡凭证调用069组别(批量交易控制器：ksys_jykzhq)的联机交易处理
10. 069组别对应批量交易码cd01(预制卡申请批处理)

**适用范围**

适用于满足条件的库管员对预制卡的申请。

### 预制卡申请批量处理（cd01)

**功能详细描述**

处理申请的预制卡申请详细，生成预制卡卡号。

**业务操作流程**

1. 批次状态设置为“正在处理''
2. 检查柜员尾箱是否正常
   * 否：批次状态设置为“处理失败”
   * 是：执行下一步
3. 申请相应数量的卡号
4. 生成凭证号
5. 登记卡凭证基础信息、凭证附加信息、卡凭证对照表
6. 检查卡号生成是否结束
   * 否：继续生成凭证号
   * 是：继续下一步
7. 检查是否存在制卡中心
   * 是：削减柜员尾箱空白卡库存——登记空白卡出入库记录——空白卡表外记账
   * 否：登记预制卡库存（在途状态）
8. 批次状态设置为“处理成功”

**业务规则**

1. 获取预制卡登记簿中处于未处理状态的信息
2. 预约1030联机cd01批量生成卡号
3. 登记卡信息登记簿，记状态为预制未打卡
4. 更新预制卡申请登记簿
5. 预制卡申请完成后，仍需生成制卡文件才能制卡

**使用范围**

适用于所有预制卡申请。

### 制卡文件生成（cd1046)

**业务规则**

1. 检查是否存在重复数据已经输入的卡号是否正确
2. 检查输入的卡号是否需要生成制卡文件
3. 当前机构为卡库上级
4. 运用表：制卡文件登记簿(kcdb_zkwjdj)、批量制卡文件生成登记主表（kcdb_plzkzb)、批量制卡文件生成附加表(kcdb_plzkfj)
5. 指定卡号处理：调用068组别，070组别

### 预制卡/预约卡入库(cd1031)

**功能详细描述**

预制卡或预约卡入支行总库。

**业务操作流程**

1. 凭证合法性检查
2. 检查是否为本机构库管员
3. 根据卡产品编号获取对应卡bin
   * 转入来源为空白卡时：减少柜员尾箱空白卡张数
   * 转入来源为非空白卡时：更改制卡在途状态
4. 增加卡产品凭证库存，同时登记卡凭证信息
5. 登记卡凭证出入库登记簿

**业务操作流程图**

![图片](预制卡预约卡入库.png)

**业务规则**

1. 入库操作需由网点大库完成
2. 本机构库管员操作
3. 检查是否存在制卡中心
   * 有制卡中心机构取当前机构，无制卡中心，则入库机构为申请卡号的机构或卡凭证总库
   * 无制卡中心，则制卡柜员不允许输入
4. 根据卡产品编号获取对应的卡bin号信息，校验与卡号的一致性
5. 入库能拼接上的号段，做号段合并
6. 运用的表：卡凭证库存登记簿（kcdb_kpzkcn)、银行卡凭证基础表（kcda_pzjcxx)
7. 入库的会计分录
   * **借：增加当前机构尾箱库存**
8. 打印交易凭证
9. 日终时，支持按卡凭证类别分别统计打印轧账单。

**适用范围**

适用于所有预制卡或预约卡的入库。

### 预制卡库间调拨（cd1032)

**功能详细描述**

发卡网点之间进行预制卡的调拨。

**业务操作流程**

1. 凭证管理合法性检查
2. 检查是否本机构库管
3. 出库时：减少交易机构库存，登记对方“调拨在途”卡库存记录
4. 入库时：检查凭证处于在途状态并更新为正常
5. 登记出入库登记簿
6. 打印交易凭证

**业务操作流程图**

![图片](预制卡库间调拨.png)

**业务规则**

1. 做凭证调拨前首先要做预制卡调拨申请（1067）和预制卡调拨申请处理（1068）
2. 必须是本机构库管员操作
3. 卡产品必须在本机构和对方机构范围内，不支持跨分行调拨
4. 检查是否已申请凭证调拨kcdb_kpzsqb(卡凭证申请登记簿)
5. 制卡中心与总行库之间不需要调拨申请
6. 检查申请张数是否和申请调拨的张数一致
7. 检查当前机构调拨的凭证张数是否满足
8. 出库凭证状态为“在途”，入库凭证状态为“正常”
9. 入库的会计分录
   1. 借：增加当前柜员库管尾箱凭证
10. 出库的会计分录
    1. 贷：减少当前库管柜员尾箱凭证；凭证在对方机构库存尾箱未记账（在途）

### 预制卡调拨申请（cd1067)

**业务规则**

1. 柜员合法性检查、凭证合法性检查
2. 检查当前柜员是否库管员
3. 登记卡凭证申请明细表（kcdl_kpzsqm)、卡凭证申请登记簿（kcdb_kpzsqb)
4. 卡库关系映射的处理（参数配置什么就采用什么关系，否则采用默认关系）

### 预制卡调拨申请处理（cd1068)

**业务规则**

1. 柜员合法性检查、凭证合法性检查
2. 检查当前交易柜员是否库管员
3. 检查空白卡凭证状态是否已启用(0)
4. 凭证表外单边记账
5. 卡凭证出入库登记簿登记信息

### 柜员领用/上缴卡凭证（cd1034)

**功能详细描述**

一般柜员/自助尾箱柜员通过本机构库管员领用/上缴卡凭证。

**业务操作流程**

1. 凭证合法性检查
2. 双方柜员合法性检查
3. 领用时：减少当前库管员库存，增加对方柜员尾箱库存
4. 上缴时：增加当前库管员库存，减少对方柜员尾箱库存
5. 登记卡凭证出入库登记簿
6. 打印交易凭证

**业务操作流程图**

![图片](柜员领用上缴.png)

**业务规则**

1. 交易柜员必须为库管员，对方柜员为具有凭证尾箱的一般柜员/自助柜员
2. 凭证合法性检查、柜员合法性检查
3. 检查尾箱库存是否满足领用/上缴的凭证张数
4. 凭证领用的会计分录

   **借：增加对方柜员机构的库存**

   **贷：减少当前柜员机构的库存**
5. 凭证上缴的会计分录

   **借：增加当前柜员机构的库存**

   **贷：减少对方柜员机构的库存**
6. 登记卡凭证出入库登记簿
7. 打印交易凭证

**适用范围**

适用于库管员卡上缴、调拨。

### 柜员间调剂卡凭证（cd1035)

**功能详细描述**

一般柜面柜员调出卡凭证给本机构内部的柜面柜员。

**业务操作流程**

1. 凭证合法性检查
2. 检查双方柜员合法性检查
3. 调出时：减少当前柜员尾箱库存，增加对方柜员尾箱库存
4. 调入时：增加当前柜员尾箱库存，减少对方柜员尾箱库存
5. 打印交易凭证

**业务操作流程图**

![图片](柜员间调剂卡凭证.png)

**业务规则**

1. 交易柜员和对方柜员均需为具有凭证尾箱的一般柜员，允许与虚拟柜员进行调剂
2. 对于调入操作，仅支持对方柜员为虚拟柜员的操作
3. 调出时减少交易柜员尾箱库存，增加对方柜员尾箱库存，调入时则相反
4. 打印交易凭证

**使用范围**

适用于柜员间卡凭证调剂。

## 开卡业务

### 实时单张发个人卡主卡（cd1010)

**功能详细描述**

用于实时单张发个人卡主卡，建立卡与客户之间的关联关系。

**业务操作流程**

1. 发卡信息合法性检查
2. 个人账户开户处理
3. 针对卡的特殊处理
4. 判断金额是否大于零
5. 查询卡内账户余额
6. 设置输出值
7. 打印交易凭证

**业务操作流程图**

![图片](实时单张发个人卡主卡.png)

**业务规则**

1. 检查黑名单（黑名单检查规则参照公共组需求）。
2. 发卡信息合法性检查、柜员参数检查。
3. 针对卡的特殊处理：若账户金额>0,账户做存入处理；否则查询卡内账户余额。
4. 开卡张数控制。
   1. 黑名单检查
   2. 客户持卡数量检查
      1. 限制类：2张以上持卡量禁止激活，如需激活，先将多余卡未激活销卡处理
   3. 主卡绑附卡张数控制：若某产品主卡最大持附卡数量为0，则不允许发附卡
5. 开卡客户持卡总量不超过4;限制类客户<=2(社保卡、医疗卡、军人保障卡、市民卡和已销户的借记卡除外)。
6. 代理人办理，检查曾经代理的主卡数量<=3张；作为监护人代理16周岁以下则无限制。
7. 代理人开卡时，卡必须经过客户本人激活才能使用。
8. 特殊情况，正常持卡人持卡数量>4张，代理人代理开卡>3张，需授权。
9. 限制类客户代理开卡<=2张，超过的不可授权通过。
10. 开户金额检查。
    1. 交易金额不能<0
    2. 一、二类账户允许非零金额开户
    3. 交易金额超过20万需授权
11. 检验客户信息完整性
    1. 注意：客户号只是贵阳银行不检查，V7是需要检查的
12. 检查卡内账户余额：将账户余额转到卡余额中。
13. 开卡时证件超过有效期不允许开卡。
14. 客户等级不满足卡产品对客户等级的要求，不允许开卡。
15. 除了普卡外，其它卡产品每人仅可发一张（通过卡产品参数配置）。
16. 交易提交后判断卡号为本卡种最小凭证号，否则不予开卡；VTM(虚拟柜员机)、发卡机则不受最小凭证号的控制。
17. 自动削减柜员尾箱卡凭证库存。
18. 登记卡凭证信息，登记客户凭证登记簿，建立与客户的关联，登记卡片发卡机构，卡片状态为正常。
19. 开户金额不为零，则存入对应的产品账户。
20. 发卡开立账户标记为Ι类账户，或者ΙΙ类账户。
21. 未取得税收声明的客户不能开立和激活账户。
22. 税收居民身份证类型为待确认的个人或单位客户在办理存款、取款、销户业务时，拒绝交易，待完善后继续办理交易。

**代码逻辑和注释记录**

1. 开卡合法性检查

   * 通过输入的卡号查询卡凭证对照表信息，拿到凭证批号是否使用，是则不检查，否则批量开卡时需要检查客户信息是否建立。(kcda_pngzdz)
   * 客户号为空时，可根据证件号码、证件种类查询客户号
   * 查询客户号是否存在（通过总线Iobus去调用cm公共模块下的cf子模块的方法）
   * 客户号不存在时，输入证件种类、证件号码。客户名称。客户号等信息进行批量开对私客户（调用cf模块的批量开对私客户方法）
   * 检查卡号是否输入
   * 卡号查询卡凭证对照表信息，判断凭证使用状态为是时，则该卡号对应的凭证序号已被使用
   * 卡号检查卡凭证基础信息表(kcda_pzjcxx)
   * 检查当前柜员尾箱是否存在卡凭证（kcdp_zaxcsb)
   * 通过输入卡号、表中的产品号检查卡产品的合法性（kcda_pzjcxx)
     * 判断通过卡号是否查询对应的卡产品
     * 判断卡号和产品号不为空时，检查该卡的产品号是否与输入的产品号一致
     * 检查卡产品属性信息（kcdp_zaxcsb):若卡产品有效期小于当前交易日期，表明该卡产品已失效
   * 卡有效期检查（kcda_pzjcxx):若卡有效期小于当前交易日期，表明该卡已过有效期
   * 检查卡凭证使用状态是否为预制
   * 卡产品的发卡方式检查：不支持实时发卡（kcdf_cpjcsx)
   * 判断卡等级是否主卡，若不是主卡或非限制卡，则该卡产品无权限发主卡（kcdf_cpjcsx)
   * 通过产品号、主卡、交易机构检查事件为发卡时，能否发出卡片的处理（包含附卡）
     * 获取卡产品基础属性表：若功能控制标志为是，发卡功能检查失败（000：表示功能开通；111：表示功能未开通），导致不能发卡。
   * 检查当前机构能否发卡(0:表明检查不通过；1：检查通过)
   * 检查卡对象是否个人卡（kcdf_cpjcsx)
   * 检查发卡地区的处理
     * 判断产品的发卡地区为99或null,则默认在全部地区可使用
     * 判断发卡地区代码和地区银行代码不匹配时，则该地区不允许发此类卡
   * 卡类型合法性检查、收费检查
     * _301:一类账户
     * _302:二类账户
     * _303:三类账户
   * 检查卡功能能否进行某项操作
     * 检查服务事件是否存在
     * 卡凭证状态检查
     * 判断是降级卡交易，拒绝操作
     * 自选预留登记簿检查，若卡号不存在，除开户外不允许进行任何操作
     * 若为睡眠卡，不允许进行任何操作，请至柜面恢复为正常卡（kcdf_cpjcsx)
     * 服务事件为卡挂失，检查是否已挂失，已挂失的卡不能再次挂失（kcda_pzjcxx)
     * **个人卡、单位卡下一般业务的检查**
       * 当卡对象为个人卡时
         * 存款、转入事件要求卡的状态为正常，或锁定为只收不付或是封闭冻结
         * 若卡号凭证状态为停用，不允许存款和转入
         * 增加卡锁定状态的处理：卡凭证控制方式为只付不收和封闭冻结时，不允许存款和转入操作（kcdb_jskadj)
         * 取款、转出事件要求卡的状态为正常，或锁定为只收不付或是封闭冻结
         * 对于换卡不换号，检查是否为正常换卡，损坏换卡，挂失换卡期间，不允许取现和转出操作（kcda_pzjcxx)
         * 理财事件检查：挂失换卡期间不允许购买理财和出售理财，非正常状态不允许作为理财划转转出/转入账户（kcdb_hkdjxx、kcda_pzjcxx)
         * 开户时检查卡凭证状态：非正常、预制、事后未打卡、待发、待启用、正式挂失和口头挂失状态，不允许开户操作
         * 销户时检查卡的状态：非锁定，非正常、非正式挂失、待启用状态的卡不允许销户
         * 锁定的卡，检查是否激活，未激活允许交易、非未激活的卡不允许销卡
         * 未激活的卡不能代扣
         * 个人非正常状态下，不允许消费和预授权
       * 当卡对象为单位卡时
         * 开户时检查卡凭证状态：非正常、预制、事后未打卡、待发、换卡不换号未打卡、换卡未打卡状态，不允许开户操作
         * 检查单位卡是否与对公账户关联，单位卡可以存款和取现、转入转出（kcdb_danwdj：单位卡信息登记簿）
         * 添加单位卡客户账号层控制：服务事件有存款、转入、取款、转出、销户、代扣、消费、预授权、理财事件
         * 单位转账白名单检查
           查询卡号白名单设置（kcdb_bmdkoz：单位结算卡白名单登记簿）
           若该单位结算卡与转账账户未设置相应的转账白名单，则不允许转账
     * 卡功能渠道控制检查-包括个人卡和单位卡
     * 发换销卡不检查功能控制事件
     * 检查卡个性化渠道功能设置
     * 根据卡等级进行处理
       添加非限制类附卡，如果是卡等级为非限制附卡，则根据外界传入的卡等级转换
       若没有传入则，默认开主卡不检查；若传入但是一定非限制类卡
       除A类附卡外,其他附卡不允许开户!
       附卡不能用于理财的转入与转出
       附卡不能销活期基本结算账户（kcda_zhaodz）
       B类附卡只能操作基本结算户
       根据卡对象、附卡等级判断授权类附卡能进行的操作
       无地区限额检查：返回标志1为通过，反则不通过
       开户金额检查，一、二类账户允许非零金额开户
       根据客户证件信息查询客户号，客户不为空时，通过客户号更新（对私、对公、同业）客户基本信息
       增加开卡张数控制，个人卡主卡数量检查
     * 批量开卡时需要检查客户信息是否建立
       若客户号为空，通过证件种类、证件号码查询客户号
       输入卡号不能为空
       查询卡凭证对照表信息，检验该卡号对应的凭证序号是否已被使用（kcda_pngzdz）
       通过卡号检查卡凭证信息：卡产品合法性检查，输入产品号和表中的是否一致、是否预制卡、对应的产品号能否发主卡和在本机构发卡、检查卡产品的发卡地区（kcda_kpzjcxx)
       当前柜员尾箱是否存在卡凭证:存款参数值：0：不存在 1：存在
       检查卡号有效期
       卡产品支持的发卡方式检查（kcdf_cpjcsx）：不支持实时发卡
       检查卡等级是否主卡、卡对象是否个人卡（kcdf_cpjcsx）
       卡类型合法性检查、收费检查
       * _301:一类账户
       * _302:二类账户
       * _303:三类账户
         开户金额检查：Ⅰ、Ⅱ类账户开户金额不能小于0
         通过客户号更新（对私、对公、同业）客户基本信息
         增加开卡张数控制 ：个人卡主卡发卡数量检查
         添加客户级别控制标志为是时，检查卡级别与客户级别是否对应 （kcdf_cpjcsx）：通过产品号和输入的客户号检查
2. 校验客户完整性
3. 检查卡内账户余额

   1. 判断是否标志为未知开立和通过开立时，通过卡号查询凭证是否使用（kcda_pngzdz),未使用则查询账户余额，否则直接查询账户余额
4. 设置输出值
   获取受理编号（kcda_pzfjxx）有效期（kcda_pzjcxx）和产品描述（kcdf_cpjcsx）
5. 打印发个人主卡
   场景打印：若收费表格信息不为空，打印返回前台的信息：1010dyxx01,5899dyxx01，否则只打印1010dyxx01
6. 发个人卡主卡主处理

* 贵阳银行社保卡特殊处理：如果已经激活金融功能的社保不发卡，未激活的继续发卡
  * 判断输入的是否标志为未知开立或通过开立时，通过输入卡号查询卡凭证对照表，判断凭证批号是否等于6217359908，且若已使用，则返回null
* 若输入账号不存在，则报请求报文账号未上送错误
* 检查该卡号是否已开户：通过输入卡号查询卡账户对照表是否存在，若不为空则已开户
* 贵阳银行的健康卡一个客户只能开一张

**适用范围**

适用于满足条件的预制卡发卡。

### 个人活期存折配卡（cd1017）

**功能详细描述**

支持活期存折配卡功能。

**业务操作流程**

1. 输入合法性检查
2. 获取卡凭证对照表
3. 获取卡杂项参数表并判断是否为空

   * 杂项参数为0：字段赋值，处理柜员凭证尾箱；
   * 其他：卡凭证使用处理
4. 检查存折账户信息
5. 注册客户账号
6. 卡折账号关联处理
7. 获取卡凭证主表信息
8. 客户信息查询
9. 登记客户凭证登记簿，更新卡凭证信息
10. 更新卡凭证信息主表和附加表
11. 登记卡账户对照表
12. 开卡下电子现金账户
13. 输出赋值

**业务操作流程图**

![图片](个人活期存折配卡.png)

**业务规则**

1. 检查黑名单（黑名单检查规则参照公共组需求）。
2. 开卡客户持卡总量<=4;限制类客户<=2(社保卡、医疗卡、军人保障卡、市民卡和已销户的借记卡除外)。
3. 代理人办理，检查曾经代理的主卡数量<=3张；作为监护人代理16周岁以下则无限制。
4. 特殊情况，正常持卡人持卡数量>4张，代理人>3张，需授权。
5. 检查存折为活期账户，将借记卡与其进行关联，已经建立关联关系的不允许再次配卡。
6. 借记卡和存折各凭密码共同使用同一结算账户。
7. 登记卡折关联关系

**使用范围**

适用于所有的个人活期存折。

## 销卡业务

### 个人卡销卡（cd1026）

**功能详细描述**

支持正常销卡、挂失销卡、损坏销卡、主卡销附卡、未激活销卡，同时支持存在部分签约关系的预约销卡处理。

**业务操作流程**

1. 销卡输入检查
2. 检查输入卡号是主卡还是附卡
   * 主卡：检查主卡信息
   * 附卡：检查附卡信息
3. 判断销卡原因
   * 挂失销户——挂失销户检查
     * 不通过：报错
     * 通过：卡挂失解挂解冻操作
   * 正常销户
4. 判断销卡方式：主卡销附卡、主卡销卡、附卡销卡
   * 主卡销附卡：检验主卡密码，不校验附卡密码，凭证合法性检查——更新卡凭证基础信息——账户汇总表修改等
   * 主卡销卡：校验密码，凭证合法性检查——销户处理
   * 附卡销卡：校验附卡密码，凭证合法性检查——更新卡凭证基础信息——账户汇总表修改等
5. 电子现金及手续费处理

**业务操作流程图**

![图片](个人卡销卡.png)

**业务规则**

1. 销卡方式：主卡销卡、附卡销卡、主卡销附卡
2. 销卡原因：挂失销卡、正常销卡/损坏销卡
3. 有关联贷款的不允许销户，需先销贷款的签约账户
4. 存在未结清的电子现金，需先清算完成才能销户
5. 存在卡折关联关系，先销折再销卡（根据银行而定）
6. 主卡卡下存在附卡和下挂了签约账户的，不能销户
7. 销卡时，账户的余额可以现金记账或转存
8. 双挂的账户不允许销户（双挂：交易密码挂失和正式挂失）
9. 挂失卡挂失期间不允许销户
10. 密码检验：附卡销卡，检验附卡密码；主卡销卡，检验主卡密码；主卡销附卡，检验主卡和附卡的密码
11. 凭证合法性检查
12. 更新凭证基础信息表，更新凭证状态为作废或已销户
13. 电子现金账户销户、负债账户销户
14. 会计分录：

    1. 现金：贷	现金尾箱（减少）	借：客户账户（减少）
    2. 转账：贷    转存账户（增加）    借：客户账户（减少）

    平衡公式：资产=负债+所有者权益
15. 检查待销毁卡凭证在系统内的关联关系，若存在关联关系，需取消关联保证卡下仅为活期账户，方可销卡。定期账户、外币账户则不能。
16. 支持虚拟卡销卡，销卡时仅检查虚拟卡账户余额是否为0，是则可以直接销卡，否则不能销卡

### 单位卡销卡（cd1027)

**功能详细描述**

用于单位结算卡销卡。销卡原因有正常销卡、损坏销卡、挂失销卡及未激活销卡。

**业务操作流程**

1. 销户检查
   * 主卡卡号不为空——主卡相关信息检查
   * 附卡卡号不为空——附卡相关信息检查
2. 判断销卡原因
   * 挂失销户——挂失销户检查
     * 不通过：报错
     * 通过：挂失解挂解冻处理
   * 非挂失销卡
3. 销卡方式
   1. 主卡销卡：检查主卡密码
   2. 主卡销附卡：检查主卡密码并按条件判断是否检查附卡密码
   3. 其他：校验附卡密码
4. 销户处理及相关表登记修改
5. 销卡时接触卡与结算户关联关系

**业务操作流程图**

![图片](单位结算卡销卡.png)

**业务规则**

1. 单位卡销卡

   1. 持卡人：需提供法人授权委托书、身份证、检验密码
   2. 经办人：需提供法人授权委托书、身份证、持卡人身份证、检查密码
2. 挂失销卡时，除了提供上述资料外，还需提供挂失回单和进行收费。凭证状态必须为挂失状态，非挂失销卡，卡凭证状态必须为正常
3. 与系统内存在关联关系，先取消关联关系，才能进行销卡
4. 在销卡前检查卡下所有关联业务是否已经结清
5. 存在签约情况，需完成解约处理再进行销卡
6. 销卡时解除卡与结算账户的关联，不销记单位结算户
7. 账户下挂子账户和未解约账户不允许销户
8. 双挂账户需7天之后才能销户
9. 密码检验：附卡销卡，检验附卡密码；主卡销卡，检验主卡密码；主卡销附卡，检验主卡和附卡的密码
10. 解除关联对公基本户
11. 更新凭证基础信息表，更新凭证状态为作废或已销户
12. 电子现金账户销户处理、负债账户销户处理
13. 会计分录：

    1. 现金：贷	现金尾箱（减少）	借：客户账户（减少）
    2. 转账：贷    转存账户（增加）    借：客户账户（减少）

**适用范围**

适用于所有满足条件的单位结算卡。

## 换卡业务

### 实时/预约单张卡换卡（cd1025)

**功能详细描述**

用于实时/预约单张个人卡和单位结算卡换卡。支持正常、挂失、损坏三种情况换卡。换卡分实时换卡和预约换卡两种方式。支持同种卡产品之间换卡，也支持不同种卡产品之间换卡。

IC坏卡换卡需要进行圈提处理。

**业务操作流程**

1. 获取旧卡凭证信息
2. 判断是否为社保卡

   * 是：退出操作
   * 否：执行下一步
3. 判断办理人、开户渠道及卡种类

   * 不通过：退出
   * 通过：执行下一步
4. 查询老卡的行业应用账户信息
5. 判断换卡原因是否为挂失补卡

   * 是：判断是否有洗钱风险，若是，弹出警告信息，否则直接执行下一步
   * 否：执行下一步
6. 判断卡种类是否在换卡登记簿中存在——不通过：退出；通过：执行下一步
7. 换卡相关信息获取与检查
8. 判断发卡方式及相关标识

   * 不通过：退出
   * 通过：继续下一步
9. 业务逻辑检查

   * 不通过：退出
   * 通过：继续下一步
10. 生产受理编号
11. 判断是否换卡不换号

    * 否：生成新卡号进行换卡操作并更新相关表信息
    * 是：进行换卡操作并更新相关表信息
12. 输出接口赋值并判断是否收费
13. 换卡信息打印

**业务操作流程图**

![图片](实时单张换卡.png)

**业务规则**

一、换卡前：

1. 黑名单检查
2. 不支持跨分行换卡，单位结算卡换卡仅可在关联账户的开户网点办理，可全行范围换个人卡
3. 换卡原因是挂失换卡时，必须输入挂失编号校验；旧卡状态为密码挂失，需要先重置密码，才能换卡

二、个人卡换卡：

1. 个人卡换卡，需检查客户等级与卡种的对应关系，客户等级满足卡产品定义方可换卡，否则应提示拒绝
2. 个人卡主卡，持二代身份证并通过联网核查，校验密码，可当场办理挂失补卡

三、单位卡换卡：

1. 由持卡人持身份证柜面办理
2. 如本人无法到现场办理，则单位出具换卡证明文件（法人授权委托书、经办持卡人身份证原件及复印件）
3. 挂失换卡除了证明文件外，还需提供挂失回单
4. 单位结算卡支持当场补卡
5. 单位结算卡换卡，加盖公章的单位证明文件需验印

四、预约换卡：

1. 如采用预约换卡，且换卡不换号，则以旧卡号作为新卡号，同时登记换卡不换号申请登记簿
2. 如预约发卡且允许换号，卡号自选或使用银行预留，则根据指定的序号/关键字生成新卡号，登记预约换卡申请
3. 根据预约新卡号登记卡凭证文件，状态置为**待发**

五、其他：

1. 检查是否为主卡，不是主卡则检查主卡的账户是否销户，否则检查账户是否已销户
2. 老卡号存在未清算的电子现金，不允许销卡
3. 虚拟卡不允许换卡（直销银行不允许）
4. 在换卡期间不允许再次换卡
   1. **注：虚拟卡补实体卡采用换卡不换号的方式，新卡非预制卡不允许换卡**
5. 检查产品是否允许换卡
6. 检查由一种产品换到另一种产品的账户余额是否足够
7. 同一个月内不允许多次换卡，保证新老卡的cvn不一致，区分新老卡
8. 换卡原因：挂失换卡、正常换卡
9. 换卡方式：客户自选、银行预留、不自选
10. 双挂不允许换卡
11. 换卡换号把老卡号全部相关信息替换成新卡号
12. 存在负债和贷款的有关卡号也要修改
13. 获取旧卡信息：**贵阳银行无预约换卡的场景，发卡方式默认为“实时换卡”**
14. 卡或账户冻结后不允许换卡，但贵阳银行金额冻结后允许换卡的
15. 柜员属性检查：自助柜员和一般柜员可以交易
16. 单位卡无附卡，单位卡换卡需授权，且仅可在关联账户的开户网点进行办理，损坏换卡和挂失换卡则不需要触发授权
17. 检查负债关联关系
    1. 若旧卡不为主卡，则检查主卡的负债账户是否销户
18. IC卡或复合卡不能被换成磁条卡
19. 老卡卡产品下存在的行业应用在新卡卡产品下不存在，不允许换卡
